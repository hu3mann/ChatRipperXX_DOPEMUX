ChatX/XtractXact Build Specification and Roadmap

1. System Summary and Scope
	•	Purpose: ChatX (a.k.a. XtractXact) is a local‑first CLI for forensic chat analysis ￼ ￼.  It ingests personal chat exports (iMessage, Instagram, WhatsApp, TXT, etc.), normalizes them into canonical JSONL formats, applies Policy Shield redaction, and builds a private vector memory for query, simulation, reply drafting, and temporal analytics ￼ ￼.  All answers must include evidence citations from the user’s chat data ￼ ￼.
	•	Goals:
	•	Privacy-by-default: On-device processing; no unredacted text or attachments ever leave the machine ￼ ￼.  Cloud or API calls are disabled by default and only occur after a strict preflight on redacted data ￼ ￼.  Each answer or simulation cites original messages/chunks for evidence ￼ ￼.
	•	Deterministic, Reproducible: Fixed seeds, schema-validated outputs, and full provenance tracking ￼ ￼.  Results must be bitwise reproducible given the same inputs and environment.
	•	Feature Scope: Extraction of chats (phase1: iMessage; later Instagram, WhatsApp, TXT); transformation to dialogue JSONL and chunked LLM blocks; Policy Shield redaction; indexing (per-contact Chroma vector DB); local-first LLM enrichment (with optional cloud after gating); label/issue analytics; HTTP query/simulate/reply endpoints (dev/local only) ￼ ￼.
	•	Non-Goals:
	•	No GUI or Hosted Service: Operates as CLI only (no UI) ￼.
	•	No Unwarranted Cloud or Data Leakage: Attachments are never uploaded. Raw or fine-grained sensitive content (e.g. explicit descriptors, CSAM, etc.) must never be sent to any cloud model ￼ ￼.  Cloud inference requires a successful Policy Shield preflight and explicit --allow-cloud flag ￼ ￼.
	•	Single-User, Local Context: Designed for one user’s data on one device.  Multi-user or real-time server hosting is out of scope at present ￼ ￼.

2. Architecture Overview
	•	High-Level Flow (C4 Context): Users invoke chatx commands in a local environment.  Chat exports feed into platform-specific Extractors which produce raw message JSON. A Transformer converts messages into a canonical Dialogue JSONL, then slices them into chunked blocks for LLM processing. A Policy Shield redactor pseudonymizes and filters content before any cloud calls ￼ ￼. Redacted outputs feed a Vector Memory (local Chroma DB per contact) for retrieval. An Enrichment Orchestrator (LLM stack, local and optional cloud) generates per-message or per-conversation features (speech acts, tone, topics, etc.) with provenance ￼ ￼. An optional HTTP API (bound to localhost) exposes /v1/query, /v1/simulate, and /v1/reply endpoints for interactive use ￼ ￼.

[User (CLI/HTTP)] 
      │
      ▼
[Extractors: iMessage, Instagram, WhatsApp, TXT]  ← (Input: chat.db, ZIP, JSON, text files)
      │
      ▼
[Transformer (Dialogue JSONL + Chunks)] 
      │
      ▼
[Policy Shield Redactor]  ← (Offline policies, pseudonymization, redact)
      │
      ▼
[Redacted Messages/Chunks] 
      │
┌──────┴──────┐
│             │
▼             ▼



[Index (Chroma)]  [Enrichment (Local LLM → optional Cloud LLM)]  ← (LLM outputs with confidence/provenance)
│             │
└──────┬──────┘
│
▼
[Query/Simulate/Reply (with evidence citations)]

- **Key Components (C4 Containers):**  
- **CLI App (`chatx`)**: Main entrypoint (Typer-based).  Registers subcommands for each pipeline step [oai_citation:29‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/INTERFACES.md#L16-L23) [oai_citation:30‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/src/chatx/cli.py#L294-L301).  
- **Extractor Modules:** Platform-specific scripts (e.g. `src/chatx/imessage.py`) handle reading raw data (e.g. SQLite `chat.db` for iMessage) and output a list of **Message** objects [oai_citation:31‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/ADRS.md#L34-L42) [oai_citation:32‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/INTERFACES.md#L65-L72).  
- **Transformer:** Reads raw messages, validates against schema, outputs Dialogue JSONL and *chunked* JSON blocks for LLM input [oai_citation:33‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/INTERFACES.md#L65-L72) [oai_citation:34‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/ACCEPTANCE_CRITERIA.md#L22-L25).  
- **Policy Shield Redactor:** Implements pseudonymization (deterministic salt), opaque placeholder tokens, and coverage enforcement. It outputs redacted JSONL and a redaction report [oai_citation:35‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/CLOUD_ENRICHMENT.md#L24-L31) [oai_citation:36‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/NON_FUNCTIONAL.md#L8-L10).  
- **Vector Memory (Chroma):** Persists embeddings of chunks (per contact) with metadata. Query/retrieval uses filters (time ranges, label facets) [oai_citation:37‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/ADRS.md#L22-L30) [oai_citation:38‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/ACCEPTANCE_CRITERIA.md#L33-L41).  
- **LLM Enrichment (Orchestrator):** Local models (e.g. Gemma/Gemini-2 9B) perform message and conversation-unit enrichment. If confidence is low and allowed, a redacted cloud fallback can augment or validate outputs [oai_citation:39‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/CLOUD_ENRICHMENT.md#L25-L33) [oai_citation:40‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/ACCEPTANCE_CRITERIA.md#L42-L50). All enrichments produce fixed JSON schemas with provenance.  
- **Analytics:** Modules for labeling, issue/episode detection, and graph analysis build additional structured outputs (issues rollups, episode lists, interaction graphs) [oai_citation:41‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/README_PROJECT.md#L46-L49) [oai_citation:42‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/INTERFACES.md#L34-L41).  
- **HTTP API (optional):** A lightweight REST server (127.0.0.1) that maps `/v1/query`, `/v1/simulate`, `/v1/reply` to the underlying CLI functions [oai_citation:43‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/README_PROJECT.md#L134-L140) [oai_citation:44‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/ACCEPTANCE_CRITERIA.md#L60-L70). It enforces a 60s SLA, RFC-7807 error format, and policy checks on inputs.

- **Data Flows:**  
1. **Extraction:** Chat archives → JSON messages.  
2. **Transform:** Raw JSON → canonical JSONL (one message per line) plus chunked blocks.  
3. **Redact:** Apply Policy Shield (pseudonymization, opaque tokens) → redacted JSONL.  
4. **Index:** Insert chunks into Chroma (metadata filters: contact, date, labels).  
5. **Enrich:** Annotate messages/units (speech act, sentiment, topics, etc.) locally; optionally call cloud LLM if local confidence < τ.  
6. **Query/Reply:** Retrieve relevant chunks, then use LLM to answer or simulate, always returning cited message IDs.

- **CI Gates & Invariants:**  
- **Code Quality:** *Every commit* MUST pass `flake8`/`mypy` and unit tests, with **≥90% test coverage** for new code [oai_citation:45‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/NON_FUNCTIONAL.md#L26-L27) [oai_citation:46‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/ACCEPTANCE_CRITERIA.md#L114-L117).  
- **Schema Validation:** All JSON outputs (messages, chunks, enrichments) MUST validate against their JSON Schema (e.g. Message, Chunk) [oai_citation:47‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/NON_FUNCTIONAL.md#L58-L60) [oai_citation:48‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/INTERFACES.md#L65-L72). CI runs a `validate` check on produced data.  
- **Policy Enforcement:** Redaction coverage *must* meet thresholds (≥0.995 normal, ≥0.999 strict) [oai_citation:49‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/NON_FUNCTIONAL.md#L8-L10). A CI gate fails if coverage is insufficient [oai_citation:50‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/NON_FUNCTIONAL.md#L8-L10). Preflight checks (via `chatx preflight cloud`) prevent any cloud usage unless no hard-fail classes (CSAM, etc.) were detected [oai_citation:51‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/CLOUD_ENRICHMENT.md#L24-L31).  
- **Privacy Invariants:** The system MUST enforce the field visibility matrix: only pseudonymized text and coarse labels go to cloud; raw identifiers, fine labels, and attachments remain local [oai_citation:52‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/CLOUD_ENRICHMENT.md#L12-L21) [oai_citation:53‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/NON_FUNCTIONAL.md#L8-L10). CI monitors for violations (`E_VISIBILITY_LEAK`, `E_ATTACHMENT_PRESENT`) [oai_citation:54‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/NON_FUNCTIONAL.md#L2-L5) [oai_citation:55‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/NON_FUNCTIONAL.md#L8-L10).  
- **Observability:** Run artifacts (e.g. `redaction_report.json`, `token_ledger.json`, validation logs) must be generated. Metrics (redaction coverage, LLM latencies, cache hits, etc.) are emitted [oai_citation:56‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/NON_FUNCTIONAL.md#L20-L24) [oai_citation:57‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/NON_FUNCTIONAL.md#L97-L105).  

## 3. Phase 1 Implementation Plan — iMessage Chat Extractor

- **CLI Entrypoint:** Implement `chatx imessage pull --contact <id>` (with optional `--db <path>` defaulting to `~/Library/Messages/chat.db`, `--include-attachments`, and `--out <dir>`) [oai_citation:58‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/INTERFACES.md#L16-L19).  This command should create `<out>/messages.jsonl`.  
- **Extraction Logic (per [ADR-0003][6]):**  
- **DB Copy:** Copy `chat.db` (and WAL) to a temp file for safe read-only access [oai_citation:59‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/src/chatx/imessage.py#L39-L42).  
- **SQL Queries:**  
  - Query the `message` table: select `ROWID AS msg_id`, `guid`, `text`, `is_from_me`, `handle_id`, `date`, `associated_message_guid`/`type`, and `cache_has_attachments` [oai_citation:60‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/src/chatx/imessage.py#L55-L64).  
  - Join `chat_message_join` to get each message’s `chat_id` and `chat.guid` (conversation ID) [oai_citation:61‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/src/chatx/imessage.py#L68-L76).  Set `conv_id` = chat GUID (or a fallback like `chat:<id>`).  
  - Load `handle` table to map `handle_id` → sender address/ID [oai_citation:62‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/src/chatx/imessage.py#L77-L78).  
  - Load `message_attachment_join` and `attachment` to collect attachment metadata (filename/type) [oai_citation:63‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/src/chatx/imessage.py#L80-L86).  
- **Timestamp Conversion:** Convert Apple epoch (`message.date`) to ISO-8601 UTC [oai_citation:64‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/src/chatx/imessage.py#L25-L33).  
- **Fields Population:** For each message row, construct a **Message** record with fields: 
  ```
  {
    "msg_id": str(msg.ROWID),
    "conv_id": str(conv_id),
    "platform": "imessage",
    "timestamp": <ISO-8601 timestamp>,
    "sender": <“Me” or handle ID string>,
    "sender_id": <“me” or address string>,
    "is_me": <bool>,
    "text": <message text or "">,
    "reply_to_msg_id": <null or msg_id of replied-to message>,
    "reactions": [ ... ],
    "attachments": [ ... ],
    "source_ref": {"guid": <chat GUID>, "path": <original chat.db path>}
  }
  ```
  This matches the **Canonical Message schema** [oai_citation:65‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/INTERFACES.md#L65-L72).  (See schema reference below.)  

- **Reactions Handling:** Fold Tapback reactions: iMessage stores a reaction as a separate message row (`assoc_type` 2000–2005 maps to reaction kinds). Detect such rows, group them under their target message, and emit them as `{"from": <sender>, "kind": <reaction>, "ts": <ISO time>}` [oai_citation:66‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/src/chatx/imessage.py#L107-L116). Skip emitting tapback rows as standalone messages.  
- **Replies:** If `associated_message_guid` indicates a reply (assoc_type *not* a tapback), set `reply_to_msg_id` to the `msg_id` of the parent message.  (The code can map GUIDs to ROWIDs.) This ensures *“stable reply_to_msg_id for replies”* as required [oai_citation:67‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/ACCEPTANCE_CRITERIA.md#L6-L10).  
- **Attachments:** Populate `attachments` with entries like `{"type": "file", "filename": "<name>"}` for each joined attachment [oai_citation:68‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/src/chatx/imessage.py#L80-L86). (Do **not** inline binaries or upload them.)  

- **Output:** Write one JSON object per line to `<out>/messages.jsonl` [oai_citation:69‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/src/chatx/cli.py#L303-L306).  Example (pre-redaction) aligns with the schema above [oai_citation:70‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/INTERFACES.md#L65-L72).  

- **Provenance:** Each message must include `source_ref={"guid":<chat_guid>,"path":<original_db_path>}` [oai_citation:71‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/INTERFACES.md#L65-L72). (Later steps will add run_id, schema_v, etc.) This satisfies *provenance* requirements [oai_citation:72‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/ACCEPTANCE_CRITERIA.md#L6-L10).

- **Tests & Fixtures:**  
- Provide a *golden* fixture SQLite `chat.db` with a small conversation (including one reply, one reaction, and one attachment).  Verify extraction yields the expected JSONL.  
- Unit tests MUST assert:  
  - All required fields (`msg_id, conv_id, platform, timestamp, sender, sender_id, is_me, text, reply_to_msg_id, reactions, attachments, source_ref`) are present and of correct type (ISO timestamp, boolean, lists) [oai_citation:73‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/INTERFACES.md#L65-L72) [oai_citation:74‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/ACCEPTANCE_CRITERIA.md#L6-L10).  
  - `is_me` correctly reflects the sender (e.g. “Me” for local user) and `sender_id` is “me” or the sender’s address.  
  - Timestamps are in ISO-8601 format.  
  - Reactions are correctly folded (e.g. a “like” TAPBACK by user yields `{"from": "Me","kind":"like","ts":<t>}`).  
  - `reply_to_msg_id` links match expected parent messages (if implemented).  
  - Attachments list has correct filenames.  
  - `source_ref.guid` matches the chat’s GUID and `source_ref.path` is the input DB path [oai_citation:75‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/INTERFACES.md#L65-L72) [oai_citation:76‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/ACCEPTANCE_CRITERIA.md#L6-L10).  
- Add regression tests: e.g., run extractor on fixture and compare JSONL diff to expected output.  

- **Definition of Done:**  
- `chatx imessage pull` accepts a contact and outputs JSONL with all fields above.  
- CI must pass all tests for this command, including schema validation and coverage≥90% [oai_citation:77‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/NON_FUNCTIONAL.md#L26-L27) [oai_citation:78‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/ACCEPTANCE_CRITERIA.md#L110-L117).  
- Documentation (README, CLI help, interfaces doc) is updated to describe the command and output format.  

## 4. Next Slices Preview (Outline)  
- **Transform to JSONL & Chunks:** Implement `chatx transform --input <raw_msgs> --to jsonl [--chunk turns:<n>|daily] [--stride <s>] --contact <key>` [oai_citation:79‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/INTERFACES.md#L20-L26) [oai_citation:80‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/ACCEPTANCE_CRITERIA.md#L22-L25). This validates raw messages, outputs one JSON line per message (same fields as extractor output), and generates *chunk* objects with `{chunk_id, conv_id, text, msg_ids, meta}`. Each chunk’s `meta` includes `{contact, platform, date_start, date_end, labels_coarse[], episode_ids[]}` [oai_citation:81‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/INTERFACES.md#L76-L82) [oai_citation:82‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/ACCEPTANCE_CRITERIA.md#L22-L25).  
- **Policy Shield Redaction:** Implement `chatx redact --input <chunks.json> --pseudonymize --opaque --threshold 0.995 [--strict] --salt-file <salt> --report <report.json>` [oai_citation:83‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/INTERFACES.md#L30-L31) [oai_citation:84‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/NON_FUNCTIONAL.md#L8-L10). This replaces sensitive tokens per policy, enforces coverage (≥0.995 normal, ≥0.999 strict) [oai_citation:85‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/NON_FUNCTIONAL.md#L8-L10), and blocks hard-fail classes. A `preflight cloud` command will verify coverage and raise `E_HARDFAIL_CLASS` or `E_VISIBILITY_LEAK` if violated [oai_citation:86‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/CLOUD_ENRICHMENT.md#L24-L31) [oai_citation:87‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/NON_FUNCTIONAL.md#L2-L5).  
- **Local Enrichment:** Implement `chatx enrich messages --contact <key> --backend local --local-model <id> --tau <0.7>` [oai_citation:88‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/CLOUD_ENRICHMENT.md#L25-L33) [oai_citation:89‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/INTERFACES.md#L42-L45). The tool will read redacted messages and run a local LLM (e.g. Gemma-2) to produce per-message enrichment (fields like `speech_act, intent, stance, tone, emotion_primary, certainty, directness, boundary_signal, repair_attempt, inferred_meaning, map_refs, confidence_llm, source="local"`) [oai_citation:90‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/CLOUD_ENRICHMENT.md#L38-L47) [oai_citation:91‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/src/chatx/schemas.py#L59-L67). All output must conform to the Enrichment schema.  
- **Hybrid Cascade & Cloud Gating:** If `--allow-cloud` and local `confidence_llm < τ` (default 0.7), perform **Cloud Pass**: call the cloud LLM with the *redacted* 5-turn window around the message [oai_citation:92‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/CLOUD_ENRICHMENT.md#L25-L33). Merge results with local output (retain higher confidence or flagged merges; set `"source":"cloud"` when cloud was used) [oai_citation:93‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/CLOUD_ENRICHMENT.md#L24-L33) [oai_citation:94‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/ACCEPTANCE_CRITERIA.md#L42-L50). Always re-validate JSON schema and record full provenance (model IDs, prompt hash, latencies) in outputs [oai_citation:95‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/CLOUD_ENRICHMENT.md#L29-L33) [oai_citation:96‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/NON_FUNCTIONAL.md#L84-L88).  
- **Indexing & Retrieval:** Implement `chatx index --input <chunks.json> --store chroma --collection chatx_<contact>` [oai_citation:97‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/INTERFACES.md#L32-L34) [oai_citation:98‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/ACCEPTANCE_CRITERIA.md#L33-L41). Store chunk vectors and metadata (date, contact, labels) in Chroma. Implement `chatx query "<question>" --contact <key> [--since/--until] [--labels-*] --k 32 --retriever local|cloud [--allow-cloud]` [oai_citation:99‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/INTERFACES.md#L46-L49) [oai_citation:100‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/ACCEPTANCE_CRITERIA.md#L33-L41). This should retrieve top-k relevant chunks (applying time/label filters) and compose an answer via the LLM, including per-chunk citations (source chunk IDs). Citation format and filtering must follow specs [oai_citation:101‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/ACCEPTANCE_CRITERIA.md#L33-L41) [oai_citation:102‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/INTERFACES.md#L46-L49).  
- **HTTP API (Dev Only):** Expose a server (127.0.0.1, port 8000) handling POST `/v1/query`, `/v1/simulate`, `/v1/reply` as per interface docs [oai_citation:103‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/README_PROJECT.md#L134-L140) [oai_citation:104‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/ACCEPTANCE_CRITERIA.md#L60-L70). JSON inputs must include `contact`, query text, filters, and `allow_cloud`. Responses `{answer, citations[], retrieval[], metrics}` (for query) or `{simulation, evidence_refs[]}` (simulate) or `{suggested_reply, citations[]}` (reply). Enforce 60s timeout, RFC-7807 error codes, and echo `X-Request-Id` if provided [oai_citation:105‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/ACCEPTANCE_CRITERIA.md#L51-L60) [oai_citation:106‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/ACCEPTANCE_CRITERIA.md#L60-L70).  

## 5. Workflow Plan  
- **Slice-by-Slice TDD:** Development proceeds in vertical *slices* (features), guided by prompt-driven test design. For each feature (e.g. iMessage extractor, transform, redactor, etc.), first write failing tests (unit and integration) and then implement code to satisfy them. Each commit focuses on one small slice to keep changes isolated.  
- **CI-Driven Integration:** All code must pass automated tests before merge. The CI pipeline includes unit tests, schema validations, policy checks, and lint/type checks [oai_citation:107‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/NON_FUNCTIONAL.md#L38-L40).  No code is committed to `main` without passing CI.  
- **Definition of Done (DoD):** A slice is Done when: its tests (including schema and policy tests) pass with ≥90% coverage; CI checks (lint, typecheck, labels lint) all pass [oai_citation:108‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/NON_FUNCTIONAL.md#L26-L27) [oai_citation:109‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/ACCEPTANCE_CRITERIA.md#L114-L117); ADRs/docs are updated if needed. Only completed slices are merged into the main branch. (Long-term: plan releases via Semantic Versioning and use Conventional Commits as badges indicate [oai_citation:110‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/README_PROJECT.md#L4-L11).)  

## 6. Conventions and Quality Gates  
- **Code Standards:** Code *MUST* conform to style (e.g. Black/flake8) and pass static type checks (mypy). `make lint-labels` enforces labels taxonomy consistency. *Commit messages* MUST follow Conventional Commits.  
- **Test Coverage:** All new code *MUST* include unit tests to achieve **≥90% line coverage** [oai_citation:111‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/NON_FUNCTIONAL.md#L26-L27). Coverage reports are generated in CI. Any reduction in coverage or new *untested* public function is disallowed.  
- **CI Workflows:** The GitHub Actions pipeline (or equivalent) *MUST* run: linting, typechecks, unit tests, schema validations, redaction coverage checks, prompt-visibility linter, and perf smoke tests [oai_citation:112‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/NON_FUNCTIONAL.md#L38-L40) [oai_citation:113‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/NON_FUNCTIONAL.md#L26-L27). A failure in any step blocks merging.  
- **Schema Validation:** CI includes a *schema test suite*; any JSON output that violates its JSON Schema should fail the build (error E_INVALID_SCHEMA).  
- **Redaction & Policy Checks:** CI enforces Policy Shield invariants: redaction coverage ≥0.995 (strict ≥0.999) [oai_citation:114‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/NON_FUNCTIONAL.md#L8-L10), no hard-fail classes, and no attachments in cloud-bound data [oai_citation:115‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/NON_FUNCTIONAL.md#L2-L5) [oai_citation:116‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/NON_FUNCTIONAL.md#L8-L10). Automated tests should simulate preflight (`chatx preflight cloud`) and expect it to abort on E_HARDFAIL_CLASS or E_VISIBILITY_LEAK when appropriate.  
- **Pseudonymization:** Identifiers (user/contacts) *MUST* be replaced with deterministic tokens (e.g. `ME`, `CN_<id>`) using a local salt file (not committed) [oai_citation:117‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/NON_FUNCTIONAL.md#L69-L71). The system *SHOULD* log mappings only in user’s workspace, not to CI or remote.  
- **Observability:** Each run *MUST* emit structured logs and artifacts. Specifically, output a `redaction_report.json` and a `token_ledger.json` per run. Logs (INFO/DEBUG) should be JSONL and exclude sensitive content. The system *SHOULD* collect metrics (coverage, throughput, latency) to `./out/metrics/*.jsonl` [oai_citation:118‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/NON_FUNCTIONAL.md#L97-L105) [oai_citation:119‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/NON_FUNCTIONAL.md#L20-L24).  
- **Security/Privacy Gates:**  
- No secrets in code. Credentials (API keys) must come from a `.env` or secure store [oai_citation:120‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/NON_FUNCTIONAL.md#L75-L80).  
- By default, network/cloud calls are disabled; requiring `--allow-cloud` ensures explicit consent [oai_citation:121‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/CLOUD_ENRICHMENT.md#L7-L10) [oai_citation:122‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/ACCEPTANCE_CRITERIA.md#L85-L89).  
- **Audit/Trace:** All enrichment outputs *MUST* include a `provenance` block (with fields like `schema_v`, `run_id`, `ts`, `model_id`, `prompt_hash`, `source_hash`, etc.) and a `shield` block (with coverage, flags) [oai_citation:123‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/CLOUD_ENRICHMENT.md#L61-L70) [oai_citation:124‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/NON_FUNCTIONAL.md#L84-L88). This allows full traceability and audit of LLM decisions.  

**Citations:** The above specification pulls definitions and requirements from the project’s design documents. For example, the canonical Message JSON schema and CLI syntax are defined in the [Interfaces](https://github.com/hu3mann/chatX/blob/main/PROJECT_DESIGN_FILES/INTERFACES.md) doc [oai_citation:125‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/INTERFACES.md#L65-L72) [oai_citation:126‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/INTERFACES.md#L16-L19). Policy Shield rules and field visibility are from the Cloud Enrichment spec [oai_citation:127‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/CLOUD_ENRICHMENT.md#L7-L10) [oai_citation:128‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/CLOUD_ENRICHMENT.md#L12-L21). Non-functional requirements (performance, safety, coverage) are drawn from NON_FUNCTIONAL and Acceptance Criteria documents [oai_citation:129‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/NON_FUNCTIONAL.md#L8-L10) [oai_citation:130‡GitHub](https://github.com/hu3mann/chatX/blob/603f5b118a0e27c7d655dac49b2be8e453296138/PROJECT_DESIGN_FILES/ACCEPTANCE_CRITERIA.md#L6-L10). All requirements above use **MUST/SHOULD** per RFC 2119.