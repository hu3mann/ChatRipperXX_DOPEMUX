{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://xtractxact.dev/schemas/image_enrichment.schema.json",
  "title": "Image Enrichment (Per Attachment)",
  "type": "object",
  "additionalProperties": false,
  "$defs": {
    "provenance": {
      "type": "object",
      "additionalProperties": false,
      "required": ["schema_v", "run_id", "model_id", "prompt_hash", "source"],
      "properties": {
        "schema_v": {"type": "string"},
        "run_id": {"type": "string"},
        "model_id": {"type": "string"},
        "prompt_hash": {"type": "string"},
        "source": {"type": "string", "enum": ["local", "cloud"]}
      }
    },
    "bbox": {
      "type": "array",
      "items": {"type": "number"},
      "minItems": 4,
      "maxItems": 4
    }
  },
  "required": ["msg_id", "attachment_index", "provenance"],
  "properties": {
    "msg_id": {"type": "string"},
    "attachment_index": {"type": "integer", "minimum": 0},
    "hash_sha256": {"type": "string"},
    "ocr": {
      "type": "object",
      "additionalProperties": false,
      "required": ["text"],
      "properties": {
        "text": {"type": "string"},
        "langs": {"type": "array", "items": {"type": "string"}},
        "spans": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "properties": {"bbox": {"$ref": "#/$defs/bbox"}}
          }
        }
      }
    },
    "objects": {
      "type": "array",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["label", "conf", "box"],
        "properties": {
          "label": {"type": "string"},
          "conf": {"type": "number", "minimum": 0, "maximum": 1},
          "box": {"$ref": "#/$defs/bbox"}
        }
      }
    },
    "category": {
      "type": "string",
      "enum": ["photo", "screenshot", "document", "whiteboard", "meme", "receipt", "menu", "other"]
    },
    "caption": {
      "type": "object",
      "additionalProperties": false,
      "properties": {"short": {"type": "string", "maxLength": 200}}
    },
    "tags": {"type": "array", "items": {"type": "string"}},
    "faces": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "count": {"type": "integer", "minimum": 0},
        "blurred": {"type": "boolean"}
      }
    },
    "similarity": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "phash": {"type": "string"},
        "clip_vec": {"type": "string"}
      }
    },
    "context_hints": {
      "type": "object",
      "additionalProperties": true,
      "properties": {
        "prev_text": {"type": "array", "items": {"type": "string"}},
        "participants": {"type": "array", "items": {"type": "string"}}
      }
    },
    "nsfw_risk": {"type": "number", "minimum": 0, "maximum": 1},
    "psych": {
      "type": "object",
      "additionalProperties": false,
      "required": ["coarse_labels", "fine_labels_local", "emotion_hint", "interaction_type", "confidence", "provenance"],
      "properties": {
        "coarse_labels": {"type": "array", "items": {"type": "string"}},
        "fine_labels_local": {"type": "array", "items": {"type": "string"}},
        "emotion_hint": {"type": "string", "enum": ["joy", "anger", "fear", "sadness", "disgust", "surprise", "neutral"]},
        "interaction_type": {"type": "string", "enum": ["collaboration", "argument", "planning", "apology", "request", "celebration", "other"]},
        "power_balance": {"type": "number", "minimum": -1, "maximum": 1},
        "boundary_health": {"type": "string", "enum": ["clear", "blurred", "violated", "rigid", "none"]},
        "confidence": {"type": "number", "minimum": 0, "maximum": 1},
        "provenance": {"$ref": "#/$defs/provenance"}
      }
    },
    "provenance": {"$ref": "#/$defs/provenance"}
  }
}

